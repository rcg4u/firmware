<!DOCTYPE html>

<html>
<head>
<title id="title">Freifunk</title>
<meta charset="utf-8"/>
<link rel="stylesheet" type="text/css" href="style.css" />
<script src="shared.js"></script>
<script src="translations.js"></script>

<script type="text/javascript">
var html_cache = {};
var js_cache = {};
var language = "de";
var adv_mode = false;


function adv_apply()
{
	var inputs = document.getElementsByClassName('adv_disable');
	var elems = document.getElementsByClassName('adv_hide');

	for (var i = 0; i < inputs.length; i++)
		inputs[i].disabled = adv_mode ? "": "disabled";

	for (var i = 0; i < elems.length; i++)
		elems[i].style.display = adv_mode ? "block" : "none";
}

/*
 * Translate all texts in a node or a tr-* string.
 */
function tr(e)
{
	if (typeof e === 'string') {
		// e is a string (tr-*)
		var fmt = translations[language][e];
		if (!fmt)
			return e;

		if (fmt.indexOf("{}") === -1) {
			return fmt;
		}

		var parts = fmt.split("{}");
		var out = "";
		for (var i = 0; i < (parts.length - 1); i++) {
			out += parts[i] + arguments[i+1];
		}

		return out + parts[parts.length - 1];
	} else {
		// iterate all translation tokens (tr-*)
		var mapping = translations[language];
		for (var id in mapping) {
			var elements = e.getElementsByClassName(id);
			if (e.classList.contains(id)) {
				e.innerText = mapping[id];
			}
			for (var i in elements) {
				elements[i].innerText = mapping[id];
			}
		}
	}
}

/*
function tr(elem) {
	if (elem) {
		for (var i = 0; i < elem.childNodes.length; i++) {
			var node = elem.childNodes[i];
			var type = node.nodeType;

			if (node.nodeName === "SCRIPT")
				continue;

			if (type == 3 && node.textContent.startsWith("tr-")) {
				console.log("'" + node.textContent + "'");
				node.textContent = tr(node.textContent);
				//console.log("'" + node.textContent + "'");
			} else if (type == 1 || type == 9 || type == 11) {
				tr(node);
			}
		}
	}
}*/

function adv_toggle(e)
{
	adv_mode = !adv_mode;

	e.classList.toggle('tr-extended-on', adv_mode);
	e.classList.toggle('tr-extended-off', !adv_mode);

	tr(e.parentNode);

	adv_apply();
}

function nav_onclick() 
{
	setText('msg', "");
	var url = this.getAttribute("href");
	if (url == '#') return false;

	var id = url.substring(0, url.lastIndexOf('.'));

	var process_html = function(data) {
		var b = $("body");
		removeChilds(b);
		var pattern = /<body[^>]*>((.|[\n\r])*)<\/body>/im;
		b.innerHTML = pattern.exec(data)[1];
		html_cache[id] = data;
	};

	var process_js = function(data) {
		(window.execScript || function(data) {
			window["eval"].call(window, data);
			window["eval"].call(window, "init();");
		})(data);
		js_cache[id] = data;
	};

	// Load HTML file
	if (id in html_cache) {
		process_html(html_cache[id]);
	} else {
		jx.load(url, process_html, 'text');
	}

	// Load JavaScript file
	if (id in js_cache) {
		process_js(js_cache[id]);
	} else {
		jx.load(url.replace(".html", ".js"), process_js, 'text');
	}

	onDesc($("globalnav"), 'UL', function(n) { hide(n); });
	onParents(this, 'UL', function(n) { show(n); });
	onChilds(this.parentNode, 'UL', function(n) { show(n); });

	onDesc($("globalnav"), 'A', function(n) { removeClass(n, "here"); });
	onParents(this, 'LI', function(n) { addClass(n.firstChild, "here"); });

	tr(document.body);

	return false;
}

function preselect() {
	onDesc($("globalnav"), 'UL', function(n) { hide(n); });
	onDesc($("globalnav"), 'A', function(n) {
		if (n.getAttribute("href") != '#')
			n.onclick = nav_onclick;
	});
	// Select the first tab.
	$("first").onclick();
}

function reboot() {
	if (!confirm("Restart the router?")) return;
	send("/cgi-bin/misc", { func : "reboot" }, function(data) {
		setText('msg', data);
	});
}

function setTitle() {
	send("/cgi-bin/misc", { func : "name" }, function(name) {
		if (name.length) {
			$("title").textContent += " - " + name;
		}
	});
}

function logout() {
	window.location="https://none@" + window.location.host;
}
</script>

</head>
<body onload="preselect(); setTitle();">
<noscript>
  <strong>JavaScript required</strong>
</noscript>

<ul id="globalnav">
	<li><a href="home.html" id="first" class="tr-home">Home</a></li>
	<li><a href="settings.html" class="tr-settings">Settings</a></li>
	<li><a href="network.html" class="tr-network">Network</a></li>
	<li><a href="wifiscan.html" class="tr-wifi-scan">WLAN-Scan</a></li>
	<li><a href="upgrade.html" class="tr-upgrade">Upgrade</a></li>
	<li><a href="password.html" class="tr-password">Password</a></li>
	<li><a href="#" onclick="reboot()" class="tr-restart">Restart</a></li>
	<li><a href="#" onclick="logout()" class="tr-logout">Logout</a></li>
	<li><a href="#" onclick="adv_toggle(this)" class="tr-extended-off">Extended: Off</a></li>
	<li><a href="#">
		<select onchange="language = this.value; tr(document.body);">
			<option value="de" selected="selected">DE</option>
			<option value="en">EN</option>
		</select></a>
	</li>
	<li class="icon">
		<a href="#" style="font-size:15px;" onclick="$('globalnav').classList.toggle('responsive')">â˜°</a>
	</li>
</ul>
<br>
<pre id="msg" tabindex="-1">To view this page, JavaScript must be enabled.</pre>

<div id="help"></div>

<div id="body"></div>

<div id="footer"></div>

</body>
</html>

